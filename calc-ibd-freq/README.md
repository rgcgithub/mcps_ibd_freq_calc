# Compute relatedness corrected allele frequencies using IBD segments
The `calc-ibd-freq` tool computes raw, relatedness corrected, and ancestry
specific allele frequencies.

Quick Start:
```
# Install calc-ibd-freq.
$ pip3 install .

# Compute raw and relatedness corrected allele frequencies.
$ calc-ibd-freq test/data/test.vcf.gz test/data/ibd_segs.txt 1 example1 --skip-ibd-header

# Compute raw, relatedness corrected, and ancestry specific frequencies.
$ calc-ibd-freq test/data/test_short.vcf.gz test/data/ibd_segs.txt 1 example2 \
    --skip-ibd-header \
    --ancestry-file test/data/test_ancestry.vcf.gz

# display additional arguments and options
$ calc-ibd-freq --help
```

## File Descriptions

### VCF/BCF Files
`calc-ibd-freq` takes as input indexed VCF or BCF files.

### IBD File
By default `calc-ibd-freq` takes as input IBD files generated by 
[hap-ibd](https://github.com/browning-lab/hap-ibd), however it can use IBD
calls generated from other callers provided each line describes one IBD
segment with the following columns. Each column has a command line argument
specifying the zero-based index of that column in the IBD file:
* `--sid1-col` ID of sample 1
* `--hid1-col` ID of haplotype on sample 1 with IBD segment
* `--sid2-col` ID of sample 2
* `--hid2-col` ID of haplotype on sample 2 with IBD segment
* `--chrom-col` Chromosome
* `--start-pos-col` Start position in number of bases
* `--end-pos-col` End position in number of bases

Calling `calc-ibd-freq` with the default arguments is equivalent to
```
$ calc-ibd-freq $VCF $IBD $CHROM $OUT \
    --sid1-col 0 \
    --hid1-col 1 \
    --sid2-col 2 \
    --hid2-col 3 \
    --chrom-col 4 \
    --start-pos-col 5 \
    --end-pos-col 6
```

`calc-ibd-freq` tries to guess the symbols specifying haplotypes from the IBD
file (e.g. 1, 2). If this fails, you can specify manually with the
`--hap1-symbol` and `--hap2-symbol` arguments.

### Ancestry File
To compute ancestry specific allele frequencies, an ancestry file is required
that includes local ancestry probabilities for each variant in the VCF. These
are encoded in their own VCF file. Populations are encoded in the REF and ALT
fields of the VCF, and local ancestry probabilities in the AP fields for each
sample. For example:
```
#CHROM POS ID   REF    ALT        QUAL  FILTER  INFO  FORMAT  SAMPLE1            SAMPLE2
1      1   ID1  POP1   POP2,POP3  .     .       .     AP      0,0.25,0.75|1,0,0  0.5,0.5,0|0.5,0.25,0.25
```
In sample 1, the variant on halotype 1 has assignment probability 0.25 to
population 2 and  0.75 assignment probability to population 3. The variant
on haplotype 2 is assigned to population 1 with probability 1. See
`test/data/test_ancestry.vcf.gz` for additional examples.

### Fam File and Chromosome X
Computing allele frequencies on chromosome X requires knowning the sex of each
sample. These must be specified in a 
[plink fam file](https://www.cog-genomics.org/plink/1.9/formats#fam) and passed
to `calc-ibd-freq` using the `--fam-file` argument.
